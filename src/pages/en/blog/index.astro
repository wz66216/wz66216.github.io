---
import BaseLayout from '../../../layouts/BaseLayout.astro';
import SearchBar from '../../../components/SearchBar.astro';
import { getCollection } from 'astro:content';
import { t } from '../../../i18n/utils';

const lang = 'en' as const;

const posts = await getCollection('blog');
const sortedPosts = posts.sort((a, b) => b.data.date.valueOf() - a.data.date.valueOf());

const categoryIcons = {
  "物理笔记": "♜",
  "国际象棋": "♞",
  "随笔": "♝"
};

// Strip markdown syntax to get plain text for search
function stripMarkdown(md: string): string {
  return md
    .replace(/\$\$[\s\S]*?\$\$/g, '')      // block LaTeX
    .replace(/\$[^$]+?\$/g, '')              // inline LaTeX
    .replace(/```[\s\S]*?```/g, '')          // code blocks
    .replace(/`[^`]+`/g, '')                 // inline code
    .replace(/!\[.*?\]\(.*?\)/g, '')         // images
    .replace(/\[([^\]]+)\]\(.*?\)/g, '$1')   // links → text only
    .replace(/^#{1,6}\s+/gm, '')             // headings
    .replace(/[*_]{1,3}([^*_]+)[*_]{1,3}/g, '$1') // bold/italic
    .replace(/^\s*[-*+]\s+/gm, '')           // list markers
    .replace(/^\s*\d+\.\s+/gm, '')           // ordered list markers
    .replace(/\n{2,}/g, ' ')                 // collapse newlines
    .replace(/\s+/g, ' ')                    // collapse whitespace
    .trim()
    .slice(0, 500);
}

// Build search data
const searchData = sortedPosts.map(post => ({
  id: post.id,
  title: post.data.title,
  title_en: post.data.title_en || '',
  description: post.data.description,
  description_en: post.data.description_en || '',
  category: post.data.category,
  body: stripMarkdown(post.body || ''),
}));
---

<BaseLayout title="Blog | Wang Zhai" lang={lang}>
  <div class="blog-container">
    <h1 class="page-title">{t(lang, 'blog.page.title')}</h1>
    <div class="chessboard-divider"></div>

    <SearchBar lang={lang} />

    <div class="filter-bar">
      <button class="filter-btn active" data-category="all">{t(lang, 'blog.filter.all')}</button>
      <button class="filter-btn" data-category="物理笔记">{t(lang, 'blog.filter.physics')}</button>
      <button class="filter-btn" data-category="国际象棋">{t(lang, 'blog.filter.chess')}</button>
      <button class="filter-btn" data-category="随笔">{t(lang, 'blog.filter.essay')}</button>
    </div>

    <div class="posts-grid">
      {sortedPosts.map((post) => (
        <a href={`/en/blog/${post.id}`} class="post-card" data-category={post.data.category} data-post-id={post.id}>
          <div class="card-content">
            <h2 class="post-title">{post.data.title_en || post.data.title}</h2>
            <div class="meta">
              <span class="date">{post.data.date.toISOString().split('T')[0]}</span>
              <span class="separator">·</span>
              <span class="category">
                <span class="icon">{categoryIcons[post.data.category as keyof typeof categoryIcons]}</span>
                {post.data.category}
              </span>
            </div>
          </div>
        </a>
      ))}
    </div>

    <div class="no-results" style="display: none;">
      <span class="no-results-icon">♚</span>
      <p class="no-results-text">{t(lang, 'search.no.results')}</p>
      <p class="no-results-hint">{t(lang, 'search.no.results.hint')}</p>
    </div>
  </div>
</BaseLayout>

<script is:inline define:vars={{ searchData }}>
  window.__searchData = searchData;
</script>

<script>
  const searchInput = document.getElementById('search-input') as HTMLInputElement;
  const buttons = document.querySelectorAll('.filter-btn');
  const cards = document.querySelectorAll('.post-card');
  const postsGrid = document.querySelector('.posts-grid') as HTMLElement;
  const noResults = document.querySelector('.no-results') as HTMLElement;

  // Store original titles for restoring after highlight removal
  const originalTitles = new Map<Element, string>();
  cards.forEach(card => {
    const titleEl = card.querySelector('.post-title');
    if (titleEl) originalTitles.set(card, titleEl.textContent || '');
  });

  function getActiveCategory(): string {
    const active = document.querySelector('.filter-btn.active');
    return active?.getAttribute('data-category') || 'all';
  }

  function getSearchQuery(): string {
    return (searchInput?.value || '').trim().toLowerCase();
  }

  function matchesSearch(postId: string, query: string): boolean {
    if (!query) return true;
    const data = (window as any).__searchData as Array<{
      id: string; title: string; title_en: string;
      description: string; description_en: string;
      category: string; body: string;
    }>;
    const entry = data.find(d => d.id === postId);
    if (!entry) return true;
    const searchable = [
      entry.title, entry.title_en,
      entry.description, entry.description_en,
      entry.body
    ].join(' ').toLowerCase();
    return searchable.includes(query);
  }

  function highlightText(text: string, query: string): string {
    if (!query) return text;
    const escaped = query.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
    const regex = new RegExp(`(${escaped})`, 'gi');
    return text.replace(regex, '<mark>$1</mark>');
  }

  function applyChessboardColors() {
    const visibleCards = Array.from(cards).filter(
      card => (card as HTMLElement).style.display !== 'none'
    );
    const isDesktop = window.innerWidth >= 768;

    // Remove previous chess classes from all cards
    cards.forEach(card => {
      card.classList.remove('chess-white', 'chess-dark');
    });

    if (visibleCards.length === 0) return;

    // Add class to grid so JS classes take priority
    postsGrid.classList.add('filtering-active');

    visibleCards.forEach((card, i) => {
      if (isDesktop) {
        // 2-col grid: W B / B W pattern
        const row = Math.floor(i / 2);
        const col = i % 2;
        const isWhite = (row + col) % 2 === 0;
        card.classList.add(isWhite ? 'chess-white' : 'chess-dark');
      } else {
        // 1-col: alternate
        card.classList.add(i % 2 === 0 ? 'chess-white' : 'chess-dark');
      }
    });
  }

  function filterPosts() {
    const query = getSearchQuery();
    const category = getActiveCategory();
    let visibleCount = 0;

    cards.forEach(card => {
      const cardEl = card as HTMLElement;
      const postId = card.getAttribute('data-post-id') || '';
      const cardCategory = card.getAttribute('data-category') || '';

      const categoryMatch = category === 'all' || cardCategory === category;
      const searchMatch = matchesSearch(postId, query);

      if (categoryMatch && searchMatch) {
        cardEl.style.display = 'block';
        visibleCount++;

        // Highlight title
        const titleEl = card.querySelector('.post-title');
        if (titleEl) {
          const original = originalTitles.get(card) || '';
          titleEl.innerHTML = highlightText(original, query);
        }
      } else {
        cardEl.style.display = 'none';

        // Restore original title
        const titleEl = card.querySelector('.post-title');
        if (titleEl) {
          titleEl.textContent = originalTitles.get(card) || '';
        }
      }
    });

    // Show/hide no-results
    noResults.style.display = visibleCount === 0 ? 'flex' : 'none';

    // Re-apply chessboard colors for visible cards
    applyChessboardColors();
  }

  // Search input listener
  searchInput?.addEventListener('input', filterPosts);

  // Category filter button listeners
  buttons.forEach(btn => {
    btn.addEventListener('click', () => {
      buttons.forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      filterPosts();
    });
  });

  // Re-apply on resize (desktop/mobile breakpoint change)
  let resizeTimer: ReturnType<typeof setTimeout>;
  window.addEventListener('resize', () => {
    clearTimeout(resizeTimer);
    resizeTimer = setTimeout(applyChessboardColors, 150);
  });
</script>

<style>
  .blog-container {
    padding: var(--space-xl) var(--space-lg);
    max-width: 1200px;
    margin: 0 auto;
  }

  .page-title {
    font-family: var(--font-title);
    font-size: clamp(2rem, 5vw, 4rem);
    font-weight: 900;
    margin-bottom: var(--space-lg);
  }

  .filter-bar {
    display: flex;
    gap: var(--space-sm);
    flex-wrap: wrap;
    margin-bottom: var(--space-xl);
  }

  .filter-btn {
    background: transparent;
    border: 1px solid var(--color-border);
    color: var(--color-text-primary);
    padding: var(--space-xs) var(--space-md);
    cursor: pointer;
    font-family: var(--font-main);
    font-size: 1rem;
    transition: all 0.2s ease;
  }

  .filter-btn:hover {
    border-color: var(--color-text-primary);
  }

  .filter-btn.active {
    background: var(--color-accent);
    color: var(--color-inverse);
    border-color: var(--color-accent);
  }

  .posts-grid {
    display: grid;
    grid-template-columns: 1fr;
    border: 1px solid var(--color-border);
  }

  .post-card {
    display: block;
    padding: var(--space-lg);
    text-decoration: none;
    transition: all 0.3s ease;
    border: 1px solid var(--color-border);
    background-color: var(--color-bg-white);
    color: var(--color-text-primary);
  }

  .card-content {
    display: flex;
    flex-direction: column;
    height: 100%;
    justify-content: center;
  }

  .post-title {
    font-family: var(--font-title);
    font-size: 1.5rem;
    font-weight: 700;
    margin-bottom: var(--space-xs);
    color: inherit;
  }

  .meta {
    font-family: var(--font-code);
    font-size: 0.9rem;
    color: inherit;
    opacity: 0.8;
    display: flex;
    align-items: center;
    gap: var(--space-xs);
  }

  .separator {
    opacity: 0.5;
  }

  /* Search highlight */
  .post-card :global(mark) {
    background: transparent;
    color: inherit;
    font-weight: 900;
    text-decoration: underline;
    text-decoration-thickness: 2px;
    text-underline-offset: 2px;
  }

  /* No results state */
  .no-results {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: var(--space-2xl) var(--space-lg);
    text-align: center;
  }

  .no-results-icon {
    font-size: 3rem;
    opacity: 0.2;
    margin-bottom: var(--space-md);
  }

  .no-results-text {
    font-family: var(--font-title);
    font-size: 1.2rem;
    font-weight: 700;
    margin-bottom: var(--space-xs);
    color: var(--color-text-primary);
  }

  .no-results-hint {
    font-family: var(--font-main);
    font-size: 0.9rem;
    color: var(--color-text-secondary);
  }

  /* === Chessboard Colors === */

  /* JS-applied classes (when filtering is active) — higher specificity */
  .posts-grid.filtering-active .post-card.chess-white {
    background-color: var(--color-bg-white);
    color: var(--color-text-primary);
  }

  .posts-grid.filtering-active .post-card.chess-dark {
    background-color: var(--color-section-dark-bg);
    color: var(--color-section-dark-text);
  }

  .posts-grid.filtering-active .post-card.chess-white:hover {
    background-color: var(--color-section-dark-bg);
    color: var(--color-section-dark-text);
  }

  .posts-grid.filtering-active .post-card.chess-dark:hover {
    background-color: var(--color-bg-white);
    color: var(--color-text-primary);
  }

  /* CSS nth-child fallback (initial page load, before any JS interaction) */

  /* Mobile (1 column) */
  @media (max-width: 767px) {
    .posts-grid {
      grid-template-columns: 1fr;
    }
    
    .post-card:nth-child(odd) {
      background-color: var(--color-bg-white);
      color: var(--color-text-primary);
    }
    
    .post-card:nth-child(even) {
      background-color: var(--color-section-dark-bg);
      color: var(--color-section-dark-text);
    }

    .post-card:nth-child(odd):hover {
      background-color: var(--color-section-dark-bg);
      color: var(--color-section-dark-text);
    }

    .post-card:nth-child(even):hover {
      background-color: var(--color-bg-white);
      color: var(--color-text-primary);
    }
  }

  /* Desktop (2 columns) */
  @media (min-width: 768px) {
    .posts-grid {
      grid-template-columns: 1fr 1fr;
    }

    .post-card:nth-child(4n+1),
    .post-card:nth-child(4n+4) {
      background-color: var(--color-bg-white);
      color: var(--color-text-primary);
    }

    .post-card:nth-child(4n+2),
    .post-card:nth-child(4n+3) {
      background-color: var(--color-section-dark-bg);
      color: var(--color-section-dark-text);
    }

    .post-card:nth-child(4n+1):hover,
    .post-card:nth-child(4n+4):hover {
      background-color: var(--color-section-dark-bg);
      color: var(--color-section-dark-text);
    }

    .post-card:nth-child(4n+2):hover,
    .post-card:nth-child(4n+3):hover {
      background-color: var(--color-bg-white);
      color: var(--color-text-primary);
    }
  }
</style>
