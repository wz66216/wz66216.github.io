---
import { getCollection, render } from 'astro:content';
import BaseLayout from '../../../layouts/BaseLayout.astro';
import GiscusComments from '../../../components/GiscusComments.astro';
import { t } from '../../../i18n/utils';

const lang = 'en' as const;

export async function getStaticPaths() {
  const posts = await getCollection('blog');
  const sorted = posts.sort((a, b) => b.data.date.valueOf() - a.data.date.valueOf());
  return sorted.map((post, i) => ({
    params: { slug: post.id },
    props: {
      post,
      prev: sorted[i + 1] || null,
      next: sorted[i - 1] || null,
    },
  }));
}

const { post, prev, next } = Astro.props;
const { Content } = await render(post);

const categoryIcons = {
  "物理笔记": "♜",
  "国际象棋": "♞",
  "随笔": "♝"
};

const categoryIcon = categoryIcons[post.data.category as keyof typeof categoryIcons];
const displayTitle = post.data.title_en || post.data.title;
const displayDesc = post.data.description_en || post.data.description;
---

<BaseLayout title={displayTitle} description={displayDesc} lang={lang}>
  <div class="post-container">
    <a href="/en/blog" class="back-link">{t(lang, 'blog.back')}</a>
    
    <article>
      <header>
        <h1 class="title">{displayTitle}</h1>
        <div class="meta">
          <time datetime={post.data.date.toISOString()}>{post.data.date.toISOString().split('T')[0]}</time>
          <span class="separator">·</span>
          <span class="category"><span class="icon">{categoryIcon}</span> {post.data.category}</span>
        </div>
      </header>


        {post.data.pdf && (
          <a href={post.data.pdf} class="pdf-download" target="_blank" rel="noopener noreferrer">
            {t(lang, 'blog.download.pdf')}
          </a>
        )}
      <div class="chessboard-divider"></div>

      <div class="content">
        <Content />
      </div>
    </article>

    <GiscusComments lang={lang} />

    <div class="nav-container">
      <div class="chessboard-divider"></div>

      <nav class="post-nav">
        {prev ? (
          <a href={`/en/blog/${prev.id}`} class="nav-link prev">
            <span class="nav-label">{t(lang, 'blog.prev')}</span>
            <span class="nav-title">{prev.data.title_en || prev.data.title}</span>
          </a>
        ) : (
          <div />
        )}
        
        {next ? (
          <a href={`/en/blog/${next.id}`} class="nav-link next">
            <span class="nav-label">{t(lang, 'blog.next')}</span>
            <span class="nav-title">{next.data.title_en || next.data.title}</span>
          </a>
        ) : (
          <div />
        )}
      </nav>
    </div>
  </div>
</BaseLayout>

<style>
  .post-container {
    padding: var(--space-xl) var(--space-lg);
    max-width: 1200px;
    margin: 0 auto;
  }

  .back-link {
    display: inline-block;
    margin-bottom: var(--space-lg);
    font-family: var(--font-code);
    font-size: 0.9rem;
    color: var(--color-text-secondary);
    text-decoration: none;
  }

  .back-link:hover {
    color: var(--color-text-primary);
    text-decoration: underline;
  }

  article {
    max-width: 720px;
    margin: 0 auto;
  }

  .title {
    font-size: clamp(1.8rem, 5vw, 2.5rem);
    font-weight: 900;
    line-height: 1.1;
    margin-bottom: var(--space-sm);
  }

  .meta {
    font-family: var(--font-code);
    color: var(--color-text-secondary);
    display: flex;
    align-items: center;
    gap: var(--space-xs);
    font-size: 0.9rem;
  }

  .separator {
    opacity: 0.5;
  }


  .pdf-download {
    display: inline-block;
    margin-top: var(--space-sm);
    padding: var(--space-xs) var(--space-md);
    font-family: var(--font-code);
    font-size: 0.9rem;
    color: var(--color-text-primary);
    border: 1px solid var(--color-border);
    text-decoration: none;
    transition: background 0.2s;
  }

  .pdf-download:hover {
    background: var(--color-bg-black);
  }
  .content {
    margin-top: var(--space-lg);
    font-family: var(--font-main);
    color: var(--color-text-primary);
  }

  /* Prose Styles */
  .content :global(p) {
    line-height: 1.8;
    margin-bottom: var(--space-md);
  }

  .content :global(h2),
  .content :global(h3) {
    font-family: var(--font-title);
    font-weight: 700;
    margin-top: var(--space-xl);
    margin-bottom: var(--space-md);
    line-height: 1.2;
  }

  .content :global(h2) {
    font-size: 1.8rem;
    border-bottom: 1px solid var(--color-border);
    padding-bottom: var(--space-xs);
  }

  .content :global(h3) {
    font-size: 1.4rem;
  }

  .content :global(code) {
    background: var(--color-bg-black);
    padding: 2px 6px;
    border-radius: 3px;
    font-family: var(--font-code);
    font-size: 0.9em;
  }

  .content :global(pre) {
    background: var(--color-bg-black);
    padding: var(--space-md);
    overflow-x: auto;
    border-radius: 4px;
    margin-bottom: var(--space-lg);
  }

  .content :global(blockquote) {
    border-left: 3px solid var(--color-border);
    padding-left: var(--space-md);
    color: var(--color-text-secondary);
    margin-bottom: var(--space-md);
    font-style: italic;
  }
  
  .content :global(ul), .content :global(ol) {
    margin-bottom: var(--space-md);
    padding-left: var(--space-lg);
  }
  
  .content :global(li) {
    margin-bottom: var(--space-xs);
    line-height: 1.6;
  }

  /* KaTeX Overflow */
  .content :global(.katex-display) {
    overflow-x: auto;
    overflow-y: hidden;
    padding: var(--space-xs) 0;
  }

  /* Bottom Nav Container */
  .nav-container {
    max-width: 720px;
    margin: 0 auto;
  }

  .post-nav {
    margin-top: var(--space-lg);
    display: flex;
    justify-content: space-between;
    gap: var(--space-md);
  }

  .nav-link {
    display: flex;
    flex-direction: column;
    max-width: 45%;
    color: var(--color-text-primary);
    text-decoration: none;
  }

  .nav-link:hover .nav-title {
    text-decoration: underline;
  }
  
  .nav-link.next {
    text-align: right;
    align-items: flex-end;
  }

  .nav-label {
    font-family: var(--font-code);
    font-size: 0.8rem;
    color: var(--color-text-secondary);
    margin-bottom: var(--space-xs);
  }

  .nav-title {
    font-family: var(--font-title);
    font-weight: 700;
    line-height: 1.2;
  }
</style>
